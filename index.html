<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuralLink // Universal AI Interface</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Orbitron & Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Vercel Web Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Orbitron', 'monospace'], // Cyberpunk font
                    },
                    colors: {
                        cyber: {
                            black: '#050505',
                            dark: '#0a0f14',
                            panel: '#11161d',
                            primary: '#00f3ff', // Cyan neon
                            secondary: '#bc13fe', // Purple neon
                            accent: '#ffe600', // Yellow accent
                            dim: 'rgba(0, 243, 255, 0.1)',
                            border: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px #00f3ff, 0 0 10px #00f3ff' },
                            '100%': { boxShadow: '0 0 20px #bc13fe, 0 0 30px #bc13fe' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Cyberpunk Background & Base Styles */
        body {
            background-color: #050505;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(188, 19, 254, 0.08) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(0, 243, 255, 0.08) 0%, transparent 25%);
            color: #e0e0e0;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0a0f14; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00f3ff; 
        }

        /* Glassmorphism & Neon Glows */
        .glass-panel {
            background: rgba(17, 22, 29, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .input-cyber {
            background: rgba(10, 15, 20, 0.8);
            border: 1px solid rgba(0, 243, 255, 0.2);
            transition: all 0.3s ease;
        }
        .input-cyber:focus {
            border-color: #00f3ff;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
            outline: none;
        }

        .btn-neon {
            background: linear-gradient(45deg, transparent 5%, #00f3ff 5%);
            color: #000;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 6px 0px 0px #bc13fe;
            transition: all 0.2s;
        }
        .btn-neon:active {
            box-shadow: 2px 0px 0px #bc13fe;
            transform: translateX(4px);
        }
        
        .btn-icon {
            transition: all 0.2s;
        }
        .btn-icon:hover {
            color: #00f3ff;
            text-shadow: 0 0 8px #00f3ff;
        }

        /* Message Bubbles */
        .msg-user {
            background: rgba(0, 243, 255, 0.1);
            border-left: 3px solid #00f3ff;
        }
        .msg-ai {
            background: rgba(188, 19, 254, 0.08);
            border-left: 3px solid #bc13fe;
        }
        
        /* Typing indicator */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Code Block Styling */
        pre {
            background: #080808 !important;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 1rem;
            overflow-x: auto;
        }
        code {
            font-family: 'Fira Code', monospace;
            font-size: 0.9em;
            color: #ff79c6;
        }
        
        /* Modal Transition */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="h-screen w-screen flex antialiased text-sm md:text-base">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 glass-panel flex flex-col h-full transform transition-transform duration-300 absolute md:relative z-20 -translate-x-full md:translate-x-0 border-r border-cyber-border">
        <!-- Logo Area -->
        <div class="p-5 border-b border-cyber-border flex items-center justify-between">
            <div class="flex items-center gap-2 text-cyber-primary font-mono font-bold text-xl tracking-wider">
                <i data-feather="cpu" class="text-cyber-secondary"></i>
                NEURAL<span class="text-white">LINK</span>
            </div>
            <button id="closeSidebar" class="md:hidden text-gray-400 hover:text-white">
                <i data-feather="x"></i>
            </button>
        </div>

        <!-- New Chat Button -->
        <div class="p-4">
            <button id="newChatBtn" class="w-full py-3 px-4 border border-cyber-primary/50 text-cyber-primary hover:bg-cyber-primary/10 rounded font-mono uppercase tracking-widest text-xs flex items-center justify-center gap-2 transition-all">
                <i data-feather="plus" class="w-4 h-4"></i>
                New Protocol
            </button>
        </div>

        <!-- Chat History List -->
        <div class="flex-1 overflow-y-auto px-3 space-y-2" id="chatHistoryList">
            <!-- Dynamic Chat Items go here -->
        </div>

        <!-- Settings Trigger -->
        <div class="p-4 border-t border-cyber-border">
            <button id="settingsBtn" class="flex items-center gap-3 text-gray-400 hover:text-cyber-primary transition-colors w-full px-2 py-2 rounded hover:bg-white/5">
                <i data-feather="settings" class="w-5 h-5"></i>
                <span>System Configuration</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative h-full w-full">
        <!-- Mobile Header -->
        <header class="md:hidden glass-panel p-3 flex items-center justify-between border-b border-cyber-border z-10">
            <button id="openSidebar" class="text-white p-2">
                <i data-feather="menu"></i>
            </button>
            <span class="font-mono text-cyber-primary font-bold tracking-widest">NEURAL<span class="text-white">LINK</span></span>
            <div class="w-8"></div> <!-- Spacer -->
        </header>

        <!-- Chat Area -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-32">
            <!-- Welcome Message (State: Empty) -->
            <div id="welcomeState" class="flex flex-col items-center justify-center h-full text-center opacity-70">
                <div class="relative mb-6">
                    <div class="absolute inset-0 bg-cyber-primary blur-3xl opacity-20 animate-pulse-slow"></div>
                    <i data-feather="box" class="w-24 h-24 text-cyber-primary relative z-10"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-mono font-bold text-white mb-2">SYSTEM READY</h1>
                <p class="text-cyber-secondary max-w-md mx-auto">Configure your API key in settings to establish a secure neural connection.</p>
            </div>
            
            <!-- Messages will be injected here -->
        </div>

        <!-- Input Area -->
        <div class="absolute bottom-0 left-0 w-full p-4 md:p-6 bg-gradient-to-t from-cyber-black via-cyber-black to-transparent">
            <form id="chatForm" class="max-w-4xl mx-auto relative glass-panel rounded-xl p-2 flex items-end gap-2">
                <button type="button" class="p-3 text-gray-400 hover:text-white transition-colors rounded-lg">
                    <i data-feather="paperclip" class="w-5 h-5"></i>
                </button>
                
                <textarea 
                    id="userInput" 
                    rows="1" 
                    class="w-full bg-transparent text-white px-2 py-3 resize-none focus:outline-none max-h-40 placeholder-gray-500 font-sans"
                    placeholder="Transmit command or query..."
                ></textarea>

                <button type="submit" id="sendBtn" class="p-3 bg-cyber-primary text-black rounded-lg hover:bg-white hover:shadow-[0_0_15px_rgba(0,243,255,0.5)] transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-feather="arrow-up" class="w-5 h-5 font-bold"></i>
                </button>
            </form>
            <div class="text-center mt-2 text-xs text-gray-600 font-mono">
                POWERED BY OPENROUTER // MODEL: <span id="currentModelDisplay" class="text-cyber-secondary">NOT CONFIGURED</span>
            </div>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel w-full max-w-md rounded-lg border border-cyber-secondary/30 shadow-[0_0_30px_rgba(188,19,254,0.15)] relative overflow-hidden">
            <!-- Modal Header -->
            <div class="p-5 border-b border-cyber-border bg-cyber-secondary/5 flex justify-between items-center">
                <h2 class="font-mono text-xl text-white flex items-center gap-2">
                    <i data-feather="sliders" class="text-cyber-secondary"></i> CONFIG
                </h2>
                <button id="closeSettings" class="text-gray-400 hover:text-white">
                    <i data-feather="x"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- API Key Input -->
                <div>
                    <label class="block text-cyber-primary text-xs font-mono mb-2 uppercase tracking-wider">OpenRouter API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" class="w-full bg-cyber-black border border-gray-700 text-white rounded p-3 focus:border-cyber-primary focus:ring-1 focus:ring-cyber-primary focus:outline-none transition-colors" placeholder="sk-or-...">
                        <button type="button" id="toggleKeyVisibility" class="absolute right-3 top-3 text-gray-500 hover:text-white">
                            <i data-feather="eye" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Key is stored locally in your browser.</p>
                </div>

                <!-- Model Input -->
                <div>
                    <label class="block text-cyber-primary text-xs font-mono mb-2 uppercase tracking-wider">Model ID</label>
                    <input type="text" id="modelInput" class="w-full bg-cyber-black border border-gray-700 text-white rounded p-3 focus:border-cyber-primary focus:ring-1 focus:ring-cyber-primary focus:outline-none transition-colors" placeholder="e.g. google/gemini-pro">
                    <p class="text-xs text-gray-500 mt-2">Specify the model identifier from OpenRouter.</p>
                </div>

                <!-- System Prompt -->
                <div>
                    <label class="block text-cyber-primary text-xs font-mono mb-2 uppercase tracking-wider">System Directive</label>
                    <textarea id="systemPromptInput" rows="3" class="w-full bg-cyber-black border border-gray-700 text-white rounded p-3 focus:border-cyber-primary focus:ring-1 focus:ring-cyber-primary focus:outline-none transition-colors text-sm" placeholder="You are a helpful AI assistant..."></textarea>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-5 border-t border-cyber-border bg-cyber-secondary/5 flex justify-end gap-3">
                <button id="cancelSettings" class="px-4 py-2 text-gray-400 hover:text-white transition-colors font-mono text-sm">CANCEL</button>
                <button id="saveSettings" class="btn-neon px-6 py-2 text-sm uppercase rounded font-mono">Initialize</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Implementation -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Initialization ---
            feather.replace();
            
            // DOM Elements
            const elements = {
                sidebar: document.getElementById('sidebar'),
                chatList: document.getElementById('chatHistoryList'),
                chatContainer: document.getElementById('chatContainer'),
                welcomeState: document.getElementById('welcomeState'),
                inputForm: document.getElementById('chatForm'),
                input: document.getElementById('userInput'),
                sendBtn: document.getElementById('sendBtn'),
                newChatBtn: document.getElementById('newChatBtn'),
                settingsBtn: document.getElementById('settingsBtn'),
                settingsModal: document.getElementById('settingsModal'),
                closeSettings: document.getElementById('closeSettings'),
                cancelSettings: document.getElementById('cancelSettings'),
                saveSettings: document.getElementById('saveSettings'),
                apiKeyInput: document.getElementById('apiKeyInput'),
                modelInput: document.getElementById('modelInput'),
                systemPromptInput: document.getElementById('systemPromptInput'),
                toggleKeyVisibility: document.getElementById('toggleKeyVisibility'),
                openSidebar: document.getElementById('openSidebar'),
                closeSidebar: document.getElementById('closeSidebar'),
                currentModelDisplay: document.getElementById('currentModelDisplay')
            };

            // State Management
            const state = {
                chats: [],
                currentChatId: null,
                config: {
                    apiKey: '',
                    model: 'google/gemini-flash-1.5', // Default fallback
                    systemPrompt: 'You are a helpful, futuristic AI assistant with a cyberpunk personality. Keep answers concise and technical.'
                },
                isGenerating: false
            };

            // --- Logic: LocalStorage & Config ---

            function loadConfig() {
                const storedConfig = localStorage.getItem('neurallink_config');
                if (storedConfig) {
                    state.config = JSON.parse(storedConfig);
                }
                // Update UI with config
                elements.apiKeyInput.value = state.config.apiKey;
                elements.modelInput.value = state.config.model;
                elements.systemPromptInput.value = state.config.systemPrompt;
                updateModelDisplay();
            }

            function saveConfig() {
                const newConfig = {
                    apiKey: elements.apiKeyInput.value.trim(),
                    model: elements.modelInput.value.trim() || 'openai/gpt-3.5-turbo',
                    systemPrompt: elements.systemPromptInput.value.trim()
                };
                
                state.config = newConfig;
                localStorage.setItem('neurallink_config', JSON.stringify(newConfig));
                updateModelDisplay();
                closeModal();
                showToast('System Configuration Updated');
            }

            function updateModelDisplay() {
                elements.currentModelDisplay.textContent = state.config.model || 'NOT SET';
            }

            function loadChats() {
                const storedChats = localStorage.getItem('neurallink_chats');
                if (storedChats) {
                    state.chats = JSON.parse(storedChats);
                    renderSidebar();
                }
            }

            function saveChatsToStorage() {
                localStorage.setItem('neurallink_chats', JSON.stringify(state.chats));
            }

            // --- Logic: Chat Management ---

            function createNewChat() {
                const newChat = {
                    id: Date.now().toString(),
                    title: 'New Protocol',
                    messages: [],
                    timestamp: Date.now()
                };
                state.chats.unshift(newChat);
                state.currentChatId = newChat.id;
                saveChatsToStorage();
                renderSidebar();
                renderChat(newChat.id);
                
                // Mobile sidebar logic
                if (window.innerWidth < 768) {
                    elements.sidebar.classList.add('-translate-x-full');
                }
            }

            function loadChat(id) {
                state.currentChatId = id;
                renderChat(id);
                renderSidebar();
                
                if (window.innerWidth < 768) {
                    elements.sidebar.classList.add('-translate-x-full');
                }
            }

            function deleteChat(e, id) {
                e.stopPropagation(); // Prevent clicking the chat item itself
                if(confirm('Terminate this protocol?')) {
                    state.chats = state.chats.filter(c => c.id !== id);
                    if (state.currentChatId === id) {
                        state.currentChatId = null;
                        elements.chatContainer.innerHTML = '';
                        elements.chatContainer.appendChild(elements.welcomeState);
                        elements.welcomeState.style.display = 'flex';
                    }
                    saveChatsToStorage();
                    renderSidebar();
                }
            }

            // --- Logic: Rendering ---

            function renderSidebar() {
                elements.chatList.innerHTML = '';
                
                state.chats.forEach(chat => {
                    const isActive = chat.id === state.currentChatId;
                    const div = document.createElement('div');
                    div.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-all duration-200 border border-transparent ${isActive ? 'bg-cyber-primary/10 border-cyber-primary/30 text-cyber-primary' : 'hover:bg-white/5 text-gray-400'}`;
                    div.onclick = () => loadChat(chat.id);
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <i data-feather="message-square" class="w-4 h-4 flex-shrink-0"></i>
                            <span class="truncate text-sm font-medium">${escapeHtml(chat.title)}</span>
                        </div>
                        <button class="opacity-0 group-hover:opacity-100 text-gray-500 hover:text-red-400 transition-opacity p-1" onclick="deleteChat(event, '${chat.id}')">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </button>
                    `;
                    elements.chatList.appendChild(div);
                });
                
                feather.replace();
            }

            function renderChat(chatId) {
                const chat = state.chats.find(c => c.id === chatId);
                if (!chat) return;

                // Hide welcome state
                elements.welcomeState.style.display = 'none';
                elements.chatContainer.innerHTML = '';

                // Render messages
                chat.messages.forEach(msg => {
                    appendMessageToDOM(msg.role, msg.content, false);
                });

                scrollToBottom();
            }

            function appendMessageToDOM(role, content, animate = true) {
                const isUser = role === 'user';
                const div = document.createElement('div');
                div.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} ${animate ? 'animate-pulse-once' : ''}`;
                
                // Formatting content (Simple markdown-like support)
                let formattedContent = escapeHtml(content);
                // Basic code block detection
                formattedContent = formattedContent.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
                // Bold
                formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>');
                // Newlines
                formattedContent = formattedContent.replace(/\n/g, '<br>');

                const avatar = isUser 
                    ? `<div class="w-8 h-8 rounded bg-cyber-primary/20 flex items-center justify-center text-cyber-primary border border-cyber-primary/50 mr-3"><i data-feather="user" class="w-4 h-4"></i></div>`
                    : `<div class="w-8 h-8 rounded bg-cyber-secondary/20 flex items-center justify-center text-cyber-secondary border border-cyber-secondary/50 mr-3"><i data-feather="cpu" class="w-4 h-4"></i></div>`;

                // Adjust layout based on role
                const innerClass = isUser 
                    ? 'msg-user max-w-[85%] md:max-w-[70%] p-4 rounded-r-lg rounded-bl-lg shadow-lg text-white'
                    : 'msg-ai max-w-[85%] md:max-w-[70%] p-4 rounded-l-lg rounded-br-lg shadow-lg text-gray-200';

                div.innerHTML = `
                    ${!isUser ? avatar : ''}
                    <div class="${innerClass} break-words overflow-hidden text-sm leading-relaxed">
                        ${formattedContent}
                    </div>
                    ${isUser ? avatar : ''}
                `;

                elements.chatContainer.appendChild(div);
                feather.replace();
                scrollToBottom();
            }

            function showTypingIndicator() {
                const div = document.createElement('div');
                div.id = 'typingIndicator';
                div.className = 'flex justify-start w-full';
                div.innerHTML = `
                     <div class="w-8 h-8 rounded bg-cyber-secondary/20 flex items-center justify-center text-cyber-secondary border border-cyber-secondary/50 mr-3"><i data-feather="cpu" class="w-4 h-4"></i></div>
                     <div class="msg-ai p-4 rounded-l-lg rounded-br-lg shadow-lg flex items-center gap-1">
                        <div class="w-2 h-2 bg-cyber-secondary rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-cyber-secondary rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-cyber-secondary rounded-full typing-dot"></div>
                     </div>
                `;
                elements.chatContainer.appendChild(div);
                scrollToBottom();
                feather.replace();
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) indicator.remove();
            }

            // --- Logic: API Interaction ---

            async function handleSendMessage(e) {
                e.preventDefault();
                const content = elements.input.value.trim();
                if (!content || state.isGenerating) return;

                if (!state.config.apiKey) {
                    openModal();
                    showToast('Please enter API Key first', 'error');
                    return;
                }

                // Prepare UI
                elements.input.value = '';
                elements.input.style.height = 'auto'; // Reset height
                state.isGenerating = true;
                elements.sendBtn.disabled = true;

                // If no active chat, create one
                if (!state.currentChatId) {
                    createNewChat();
                }

                const currentChat = state.chats.find(c => c.id === state.currentChatId);

                // Add User Message
                const userMsg = { role: 'user', content: content };
                currentChat.messages.push(userMsg);
                appendMessageToDOM('user', content);

                // Update Title if first message
                if (currentChat.messages.length === 1) {
                    currentChat.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    renderSidebar();
                }

                showTypingIndicator();

                try {
                    // Prepare Payload
                    const messagesPayload = [
                        { role: 'system', content: state.config.systemPrompt },
                        ...currentChat.messages.map(m => ({ role: m.role, content: m.content }))
                    ];

                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${state.config.apiKey}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.href, // Required by OpenRouter
                            "X-Title": "NeuralLink Interface"
                        },
                        body: JSON.stringify({
                            "model": state.config.model,
                            "messages": messagesPayload
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'Connection Failed');
                    }

                    const data = await response.json();
                    const aiContent = data.choices[0]?.message?.content || 'Empty response received.';

                    removeTypingIndicator();

                    // Add AI Message
                    const aiMsg = { role: 'assistant', content: aiContent };
                    currentChat.messages.push(aiMsg);
                    appendMessageToDOM('assistant', aiContent);
                    
                    // Save
                    saveChatsToStorage();

                } catch (error) {
                    removeTypingIndicator();
                    appendMessageToDOM('assistant', `[SYSTEM ERROR: ${error.message}]`);
                } finally {
                    state.isGenerating = false;
                    elements.sendBtn.disabled = false;
                    elements.input.focus();
                }
            }


            // --- Utilities ---

            function scrollToBottom() {
                elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            }

            function escapeHtml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function showToast(msg, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 text-white font-mono text-sm border ${type === 'error' ? 'bg-red-900/80 border-red-500' : 'bg-cyber-panel border-cyber-primary'}`;
                toast.textContent = msg;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            // --- Modal Handling ---
            function openModal() {
                elements.settingsModal.classList.add('active');
            }
            function closeModal() {
                elements.settingsModal.classList.remove('active');
            }

            // --- Event Listeners ---

            elements.input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    elements.inputForm.dispatchEvent(new Event('submit'));
                }
            });

            // Auto-expand textarea
            elements.input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });

            elements.inputForm.addEventListener('submit', handleSendMessage);

            elements.newChatBtn.addEventListener('click', createNewChat);
            elements.settingsBtn.addEventListener('click', openModal);
            elements.closeSettings.addEventListener('click', closeModal);
            elements.cancelSettings.addEventListener('click', closeModal);
            elements.saveSettings.addEventListener('click', saveConfig);

            elements.toggleKeyVisibility.addEventListener('click', () => {
                const type = elements.apiKeyInput.getAttribute('type') === 'password' ? 'text' : 'password';
                elements.apiKeyInput.setAttribute('type', type);
                // Toggle icon logic could go here, for now keeping simple
            });

            elements.openSidebar.addEventListener('click', () => {
                elements.sidebar.classList.remove('-translate-x-full');
            });
            elements.closeSidebar.addEventListener('click', () => {
                elements.sidebar.classList.add('-translate-x-full');
            });

            // Make deleteChat accessible globally for onclick
            window.deleteChat = deleteChat;

            // --- Boot ---
            loadConfig();
            loadChats();
        });
    </script>
</body>
  </html>
